---
title: Appendix
sidebar_label: Appendix
hide_title: true
description: Mesa Upgrade Appendix
keywords:
  - Mesa
  - upgrade
  - appendix
---

# Appendix

## Upgrading archive nodes from Berkeley to Mesa

Below we present details of what changed in the archive node database schema between Berkeley and Mesa versions.

### Extended zkApp State Fields

**zkapp_states_nullable table**
   - Added columns `element8` through `element31` (nullable integer fields)
   - Each new column references `zkapp_field(id)`
   - These fields allow zkApps to store additional state information beyond the original 8 elements

```sql
ALTER TABLE zkapp_states_nullable ADD COLUMN IF NOT EXISTS element8 INT REFERENCES zkapp_field(id);
...
ALTER TABLE zkapp_states_nullable ADD COLUMN IF NOT EXISTS element31 INT REFERENCES zkapp_field(id);
```

**zkapp_states table**
   - Added columns `element8` through `element31` (non-nullable integer fields)
   - Each new column references `zkapp_field(id)` with a default value pointing to the zero field
   - Unlike the nullable version, these fields are required and default to the zero field ID

```sql
ALTER TABLE zkapp_states ADD COLUMN IF NOT EXISTS element8 INT DEFAULT <zero_field_id> NOT NULL REFERENCES zkapp_field(id);
...
ALTER TABLE zkapp_states ADD COLUMN IF NOT EXISTS element31 INT DEFAULT <zero_field_id> NOT NULL REFERENCES zkapp_field(id);
```

### Migration History Tracking

The upgrade introduces a new `migration_history` table to track database schema migrations. This helps manage future upgrades and prevents applying the same migration multiple times.

**migration_status enum type**
```sql
CREATE TYPE migration_status AS ENUM ('starting', 'applied', 'failed');
```

**migration_history table**
```sql
CREATE TABLE IF NOT EXISTS migration_history (
    commit_start_at   TIMESTAMPTZ NOT NULL DEFAULT NOW() PRIMARY KEY,
    protocol_version  TEXT NOT NULL,
    migration_version TEXT NOT NULL,
    description       TEXT NOT NULL,
    status            migration_status NOT NULL
);
```

The table tracks:
- **commit_start_at**: Timestamp when the migration started
- **protocol_version**: Target protocol version (e.g., '4.0.0' for Mesa)
- **migration_version**: Version of the migration script itself (e.g., '0.0.5')
- **description**: Human-readable description of the migration
- **status**: Current state of the migration (starting, applied, or failed)

The migration script uses protocol version '3.0.0' for Berkeley and '4.0.0' for Mesa, with built-in safety checks to prevent reapplying migrations or running them on incorrect database versions.