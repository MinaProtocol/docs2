---
title: Archive migration prerequisites
sidebar_label: Archive migration prerequisites
hide_title: true
description: Overview of the migration tools and requirements to successfully migrate Devnet/Mainnet archive database.
keywords:
  - Berkeley
  - upgrade
  - archive migration
  - planning 
  - prerequisites
  - mina archive node
  - archive node
---

# Planning the Archive Migration

Before you start the migration of your archive node database into the Berkeley version of the Mina network, read this document in entirety.

## Overview

Archive node migration is a crucial part of Berkeley upgrade. We need to convert devnet/mainnet database to berkeley one in order to preserves historical data and assure archive node chain continuity.
For this purpose o1Labs and mina-foundation teams prepared two packages:

### Archive Node Berkeley migration package

This package contains applications needed to migrated existing devnet/mainnet database into new bekeley schema.
Briefly it contains 3 apps and 1 usability script:

1. **berkeley-migration**

  The berkeley-migration application migrates as much data as possible from the Devnet/Mainnet database and downloads precomputed blocks to get the window density data. 
  
  This application runs against the Devnet/Mainnet and the new database.

2. **replayer in migration mode**

  The existing replayer application is enhanced with a new mode: migration mode. Replayer in migration mode analyzes the transactions in the partially migrated database and populates the `accounts_accessed` and `accounts_created` tables. This application also does the checks performed by the standard replayer, but does not check ledger hashes because the Berkeley ledger has greater depth, which results in different hashes. This application runs only against the new archive database.

4. **berkeley-migration-verifier**

  The berkeley-migration-verifier is a verification software which helps to determine if migration (even incomplete) was successful by utilizing validations on migrated database

5. ** end-to-end migration script**

  Migration script is a shell script which wraps all phases and stages of migration into single script. It is provided purely for node operators usability and is equivalent of running berkely-migration, replayer in migration mode and berkeley-migration-verifier apps in correct order

#### Incrementality

The berkeley-migration and replayer applications are able to work incrementally so that part of the Devnet/Mainnet database can be migrated and, as new blocks are added to the Devnet/Mainnet, the new data in the database can be migrated.

To obtain that incrementality, the berkeley-migration application can look at the migrated database and determine the most recent migrated block. It can continue migrating starting at the next block in the Devnet/Mainnet data. The replayer app in migration mode can use the checkpoint mechanism already in place for the replayer. A checkpoint file indicates the global slot since genesis for starting the replay and the ledger to use for that replay. The application writes new checkpoint files as it proceeds.

To take advantage of the incrementality, you can run a cron job that migrates a day's worth of data at a time (or some other interval). With the cron job in place, at the time of the actual Berkeley, only a small amount of data will need to be migrated.


### Archive maintenance package

Archive Node Berkeley migration package is sufficient for staisfying migration from devnet/mainnet to Berkeley.
However, it has some limitations. For example it won't migrate non-canonical chain. It will skip orphaned (blocks which are not part of canonical-chain). 
For this purpose we are also releasing archive maintenance package for those Archive Node operators who wants to still mainntain copy of devnet/mainnet database for historical reasons.

## Prerequisites

To successfully migrate the archive database into the Berkeley version of the Mina network, the foundational requirements are:

#### Migration host

- PostgreSQL database for datbase server
- If Docker is used, then any of the supported OS by Mina (Bullseye, Focal, or Buster) with at least 32 GB of RAM
- gsutil application from Google Cloud Suite in version 5 or later
- (Optional) Docker in version 23.0 or later


#### (Optional) Devnet/Mainnet database 

One of the most obvious prerequisite is a mainnt database.
If you don't have an existing database with Devnet/Mainnet archive data, you can always download it from our Google Cloud bucket. However, we strongly encourage to perform migration on your own data in order to preserve idea of decentralization
As mentioned

#### (Optional) Google Cloud bucket with Devnet/Mainnet precomputed blocks

Precomputed blocks are the jsons files which correctly configured node will updload to gcloud bucket.
The Devnet/Mainnet to Berkeley archive data migration requires access to precomputed blocks that are uploaded by daemons connected to the Devnet/Mainnet network respectively. The Berkeley migration app uses the gsutil app to download blocks. If you didn't store precomputed blocks during first phase of migration, you can use the precomputed blocks provided by Mina Foundation.
However, we strongly encourage to perform migration on your own data in order to preserve idea of decentralization:

For Devnet blocks:
`gsutil cp gs://mina_network_block_data/devnet-*.json .`

For Mainnet blocks:
`gsutil cp gs://mina_network_block_data/mainnet-*.json .`

:warning: Precomputed blocks for 'mainnet' network takes ~800Gb. Downloading them make take some time 

The best practice is to collect precomputed blocks by yourself or by other third parties to preserve idea of decentralization. 


## Instalation

#### Download o1labs mainnet archive database

We strongly encourage to perform migration on your own data in order to preserve idea of decentralization. However, if you'd like to use archive data o1labs runs, follow the steps below.

1. Download the Devnet/Mainnet archive data using cURL or gsutil:

- cUrl:

   For Devnet:
   ```sh
   curl https://storage.googleapis.com/mina-archive-dumps/devnet-archive-dump-{date}_0000.sql.tar.gz
   ```

   For Mainnet:   
   ```sh
   curl https://storage.googleapis.com/mina-archive-dumps/mainnet-archive-dump-{date}_0000.sql.tar.gz
   ```

   You can filter the dumps by date. Replace `{date}` using the required `yyyy-dd-mm` format. For example, for January 15, 2024 you can provide `2024-01-15`

   :warning: Majority of backups are suffixed with 0000, in case download with that name is not available, try incrementing it once or twice(0001, 0002)..

- gsutil:
   
   ```sh
   gsutil cp gs://mina-archive-dumps/mainnet-archive-dump-2024-01-15* .
   ```

2. Extract the tar package.

   ```sh
   tar -xvzf {network}-archive-dump-{date}_0000.sql.tar.gz {network}-archive-dump-{date}_0000.sql
   ```

3. Import the Devnet/Mainnet archive dump into the Berkeley database.

   Run this command at the database server:

   ```sh
   psql -U {user} -f {network}-archive-dump-{date}_0000.sql
   ```

   An **archive_balances_migrated** schema is created with the Devnet/Mainnet archive.
   Note: This is not with berkeley changes.

### Ensure location of Google Cloud bucket with Devnet/Mainnet precomputed blocks

We strongly encourage to perform migration on your own data in order to preserve idea of decentralization

`gsutil cp gs://mina_network_block_data/{network}-*.json .`

:warning: Precomputed blocks for 'mainnet' network takes ~800Gb. Downloading them make take some time. Berkeley migration app will download them incrementally only when needed 

### Validate the Devnet/Mainnet database

The correct Devnet/Mainnet database state is crucial for a successful migration. 

Missing blocks is one the most frequent issues when dealing with the Devnet/Mainnet archive. Although this step is optional, it is strongly recommended to verify the archive condition before you start the migration process.

Please refer to our guide for more information: [How to maintain archive data](/berkeley-upgrade/mainnet-database-maintenance)

## Download migration applications

Migration applications are distributed as part of the archive migration Docker and Debian packages.

Choose packages appropriate for your environment. 

The following commands help you install Debian packages or Docker images.

### Debian packages

```
CODENAME=bullseye
CHANNEL=umt
VERSION=1.0.0umt-tooling

echo "deb [trusted=yes] http://packages.o1test.net $CODENAME $CHANNEL" | tee /etc/apt/sources.list.d/mina.list
apt-get update
apt-get install --allow-downgrades -y "mina-archive-berkeley-archive-migration=$VERSION"
```

### Docker Image

To get the Docker image:


```
docker pull gcr.io/o1labs-192920/mina-archive-berkeley-archive-migration:1.0.0umt-tooling
```

## Devnet/Mainnet Genesis Ledger

The Mina Devnet/Mainnet genesis ledger is stored in GitHub in the `mina` repository under the `genesis_ledgers` subfolder. However, if you are already running a daemon that is connected to the Mina Mainnet or the Devnet network, you already have the genesis ledger locally.

## Berkeley database schema files

You can get the Berkeley schema files from different locations:

- GitHub repository under `berkeley` branch. 

    Note: The `berkeley` branch can contain new updates regarding schema files, so always get the latest schema files instead of using an already downloaded schema. 
- Archive/Rosetta Docker from `berkeley` version

### Example: Downloading schema sources from GitHub

   ```sh
   wget https://raw.githubusercontent.com/MinaProtocol/mina/berkeley/src/app/archive/zkapp_tables.sql

   wget https://raw.githubusercontent.com/MinaProtocol/mina/berkeley/src/app/archive/create_schema.sql

   ```

## Next steps

You are now ready to perform migration. See:

- [How to perform archive migration](/berkeley-upgrade/planning-archive-migration)
